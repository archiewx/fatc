!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.PmIndexed=e()}(this,function(){"use strict";var n,e,i=Object.assign||function(n){for(var e,t=1,r=arguments.length;t<r;t++)for(var o in e=arguments[t])Object.prototype.hasOwnProperty.call(e,o)&&(n[o]=e[o]);return n};function f(t,r){var o,i,c,n,s={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return n={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function e(e){return function(n){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(c=2&e[0]?i.return:e[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,e[1])).done)return c;switch(i=0,c&&(e=[2&e[0],c.value]),e[0]){case 0:case 1:c=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(c=0<(c=s.trys).length&&c[c.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!c||e[1]>c[0]&&e[1]<c[3])){s.label=e[1];break}if(6===e[0]&&s.label<c[1]){s.label=c[1],c=e;break}if(c&&s.label<c[2]){s.label=c[2],s.ops.push(e);break}c[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(t,s)}catch(n){e=[6,n],i=0}finally{o=c=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,n])}}}(e=n||(n={})).READWRITE="readwrite",e.READONLY="readonly",e.READWRITEFLUSH="readwriteflush",e.VERSIONCHANGE="versionchange";var d="production"!==process.env.NODE_ENV,t={log:function(n){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];console.log.apply(console,["[promisify log]",n].concat(e))},warn:function(n){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];console.warn.apply(console,["[promisify warn]",n].concat(e))},error:function(n){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];console.error.apply(console,["[promise error]",n].concat(e))}},l=t.log,h=t.warn,w=t.error,r=0,o={startTiming:function(){return r=Date.now(),!0},finishTiming:function(){return Date.now()-r}},c=o.startTiming,s=o.finishTiming;return function(n){var u=this;if(this.compatibilityCheck=function(){var n=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,e=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,t=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;return n&&e&&t},this.createIndexedDBInstance=function(){return u.IndexedDBInstance||(u.IndexedDBInstance=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),u.IndexedDBInstance},this.checkDb=function(){if(!u.db){var n="未连接数据库IndexedDB["+u.dbname+"]";throw d&&h(n),new Error(n)}return u.db},this.checkTransaction=function(){if(!u.transaction){var n="未开启事务["+u.dbname+"]";throw d&&h(n),new Error(n)}return u.transaction},this.getDBInstance=function(){return u.checkDb()},this.getTransactionInstance=function(){return u.checkTransaction()},this.open=function(){var o=u.createIndexedDBInstance().open(u.dbname,u.version||1);return new Promise(function(e,t){o.onupgradeneeded=function(n){d&&h("更新当前["+u.dbname+"]"),u.db=o.result;for(var e=0,t=u.stores;e<t.length;e++){var r=t[e];u.createObjectStore(r.storeName,i({},r.optional))}},o.onsuccess=function(n){d&&l("初始化成功"),u.db=o.result,e&&e(u)},o.onerror=function(n){throw d&&h("初始化数据库失败"),t&&t(n),new Error("初始化数据库失败")}})},this.createObjectStore=function(n,e){void 0===e&&(e={keyPath:"id",autoIncrement:!1});var t=u.checkDb(),r=t.objectStoreNames,o=Array.from(r);return o.length&&-1!==o.indexOf(n)?d&&l("存在objectStores",r):(d&&l(n+"创建成功"),t.createObjectStore(n,i({},e))),u},this.count=function(n){var r=u.checkTransaction().objectStore(u.storeName).count(n);return new Promise(function(t,e){r.onsuccess=function(n){var e=r.result;d&&l("获取到"+e+"条数数据"),t(e)},r.onerror=function(n){d&&w("获取count失败"),e(n)}})},this.startTransaction=function(n,e){void 0===e&&(e="readwrite"),u.storeName=n;var t=u.checkDb();d&&c()&&l("开启事务");var r=t.transaction(n,e);return u.transaction=r,new Promise(function(n,e){r.oncomplete=function(){d&&l("["+u.storeName+"]执行成功,完成事务, 用时:"+s()+"ms")},r.onerror=function(n){d&&w(n),e&&e(n)},n(u)})},this.add=function(n){var r=u.checkTransaction().objectStore(u.storeName),e=r.keyPath;if(!e)return Promise.resolve(u);"object"==typeof e&&(e=e[0]);var o=e;return Promise.all(n.map(function(t){return i=u,a=function(){var e;return f(this,function(n){switch(n.label){case 0:return[4,this.get(t[o])];case 1:return n.sent()?d&&h("已存在该数据",t):((e=r.add(t)).onsuccess=function(){d&&l("添加一条成功:",t)},e.onerror=function(n){throw d&&w(n),new Error("添加失败")}),[2]}})},new((s=c=void 0)||(s=Promise))(function(n,e){function t(n){try{o(a.next(n))}catch(n){e(n)}}function r(n){try{o(a.throw(n))}catch(n){e(n)}}function o(e){e.done?n(e.value):new s(function(n){n(e.value)}).then(t,r)}o((a=a.apply(i,c||[])).next())});var i,c,s,a})).then(function(){return d&&l("全部添加成功"),u}).catch(function(n){throw d&&l("添加失败"),new Error(n)})},this.get=function(n){return new Promise(function(e,t){var r=u.checkTransaction().objectStore(u.storeName).get(n);r.onsuccess=function(n){d&&l("获取成功:",r.result),e(r.result)},r.onerror=function(n){d&&w("获取失败",n),t(n)}})},this.getAll=function(n){var r=u.openCursor(n),o=[];return new Promise(function(t,e){r.onsuccess=function(n){var e=r.result;e?(o.push(e.value),e.continue()):(d&&l("获取全部数据成功"),t(o))},r.onerror=function(n){d&&w("获取全部数据失败",n),e(n)}})},this.delete=function(t){var r=u.checkTransaction().objectStore(u.storeName).delete(t);return new Promise(function(n,e){r.onsuccess=function(){d&&l(t.toString()+"删除成功"),n(u)},r.onerror=function(n){d&&l(t.toString()+"删除失败"),e(n)}})},this.clear=function(n){var r=u.checkTransaction().objectStore(u.storeName).openCursor(n);return new Promise(function(t,e){r.onsuccess=function(n){var e=r.result;e?(e.delete(),e.continue()):(d&&h("清空["+u.storeName+"]数据成功"),t(u))},r.onerror=function(n){d&&w("清空["+u.storeName+"]数据失败"),e(n)}})},this.put=function(n,e){var t=u.checkTransaction().objectStore(u.storeName).put(n,e);return new Promise(function(n,e){t.onsuccess=function(){d&&l("更新成功"),n(u)},t.onerror=function(n){d&&w("更新失败"),e(n)}})},this.openCursor=function(n,e){return void 0===e&&(e="next"),u.checkTransaction().objectStore(u.storeName).openCursor(n,e)},this.close=function(){var t=u.checkDb();return new Promise(function(n,e){t.onerror=function(n){d&&w("关闭数据库错误"),e(n)},t.close()})},this.dbname=n.dbname,this.version=n.version,this.stores=n.stores,this.IndexedDBInstance=null,this.db=null,this.storeName="",this.transaction=null,!this.compatibilityCheck)throw new Error("当前浏览器不支持indexedDB")}});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgubWluLmpzIiwic291cmNlcyI6W10sInNvdXJjZXNDb250ZW50IjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiJ9
